name: CI

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

permissions:
  contents: read
  pull-requests: write

env:
  NODE_VERSION: "20"
  OPENTOFU_VERSION: "1.8.0"

jobs:
  # Build and test the application
  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  # Validate OpenTofu configuration
  tofu-validate:
    name: OpenTofu Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: OpenTofu Format Check
        run: tofu fmt -check -recursive

      - name: OpenTofu Init
        run: tofu init -backend=false

      - name: OpenTofu Validate
        run: tofu validate

  # OpenTofu plan on PRs
  tofu-plan:
    name: OpenTofu Plan
    runs-on: ubuntu-latest
    needs: [build, tofu-validate]
    if: github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: terraform
    env:
      TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      AWS_ENDPOINT_URL_S3: https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: OpenTofu Init
        id: init
        run: tofu init

      - name: OpenTofu Plan
        id: plan
        run: |
          tofu plan -no-color -out=tfplan 2>&1 | tee plan_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate Plan Summary
        id: plan-summary
        run: |
          # Extract resource changes summary
          if grep -q "No changes" plan_output.txt; then
            echo "summary=‚úÖ No changes. Infrastructure is up-to-date." >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            ADD=$(grep -oP '\d+(?= to add)' plan_output.txt || echo "0")
            CHANGE=$(grep -oP '\d+(?= to change)' plan_output.txt || echo "0")
            DESTROY=$(grep -oP '\d+(?= to destroy)' plan_output.txt || echo "0")
            echo "summary=üìä **$ADD** to add, **$CHANGE** to change, **$DESTROY** to destroy" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment Plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('terraform/plan_output.txt', 'utf8');
            const planExitCode = '${{ steps.plan.outputs.exitcode }}';
            const summary = '${{ steps.plan-summary.outputs.summary }}';
            const hasChanges = '${{ steps.plan-summary.outputs.has_changes }}' === 'true';

            // Truncate if too long (GitHub comment limit is 65536 chars)
            const maxLength = 60000;
            let planText = planOutput;
            let truncated = false;
            if (planText.length > maxLength) {
              planText = planText.substring(0, maxLength);
              truncated = true;
            }

            const statusIcon = planExitCode === '0' ? '‚úÖ' : '‚ùå';
            const statusText = planExitCode === '0' ? 'Success' : 'Failed';

            const output = `## ${statusIcon} OpenTofu Plan ${statusText}

            ${summary}

            <details>
            <summary>üìã Click to expand full plan output</summary>

            \`\`\`diff
            ${planText}
            \`\`\`

            ${truncated ? '‚ö†Ô∏è *Plan output was truncated due to length*' : ''}

            </details>

            ---
            *Pushed by: @${{ github.actor }} | Commit: \`${{ github.sha }}\`*`;

            // Find existing bot comment to update instead of creating new ones
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('OpenTofu Plan')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              });
            }

      - name: Plan Status
        if: steps.plan.outputs.exitcode != '0'
        run: exit 1
